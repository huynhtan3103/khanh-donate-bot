// ===== KHANH TRANN DONATE BOT =====
// T·∫°o b·ªüi AI Assistant cho Khanh Trann
// Bot nh·∫≠n donate b·∫±ng Telegram Stars
// Bot Token: 8345096885:AAGiwUX74HOYNOwAYpZlupBs8AXnokipGZw
// TON Wallet: UQAz_a6I4tlAkkNescqIaUk38ojeRjxkHLx_abQirriHbk_L

const express = require('express');
const TelegramBot = require('node-telegram-bot-api');
const path = require('path');
const fs = require('fs');

const app = express();
const port = process.env.PORT || 3000;

// Bot configuration
const BOT_TOKEN = '8345096885:AAGiwUX74HOYNOwAYpZlupBs8AXnokipGZw';
const bot = new TelegramBot(BOT_TOKEN);

// Enable webhook mode
app.use(express.json());

// Donate amounts configuration
const DONATE_AMOUNTS = {
    20: {
        emoji: '‚òï',
        title: 'M·ªôt ly c√† ph√™ nh·ªè',
        message: '‚òï C·∫£m ∆°n b·∫°n ƒë√£ ·ªßng h·ªô m·ªôt ly c√† ph√™!\nR·∫•t c·∫£m ∆°n s·ª± support c·ªßa b·∫°n! üíñ'
    },
    50: {
        emoji: 'üçú',
        title: 'B·ªØa tr∆∞a ngon l√†nh',
        message: 'üçú C·∫£m ∆°n b·∫°n ƒë√£ ·ªßng h·ªô b·ªØa tr∆∞a!\nB·∫°n ƒë√£ gi√∫p t√¥i c√≥ b·ªØa ƒÉn ngon! üíñ'
    },
    100: {
        emoji: 'üöÄ',
        title: 'ƒê·ªông vi√™n tinh th·∫ßn',
        message: 'üöÄ C·∫£m ∆°n s·ª± ƒë·ªông vi√™n m·∫°nh m·∫Ω!\nƒêi·ªÅu n√†y th·ª±c s·ª± c√≥ √Ω nghƒ©a v·ªõi t√¥i! üíñ'
    },
    250: {
        emoji: 'üëë',
        title: 'Si√™u supporter VIP',
        message: 'üëë WOW! B·∫°n l√† VIP supporter!\nC·∫£m ∆°n b·∫°n r·∫•t r·∫•t nhi·ªÅu! B·∫°n th·∫≠t tuy·ªát v·ªùi! üíñ‚ú®'
    }
};

// Database (simple JSON file for demo)
const DB_FILE = 'donations.json';

function initDatabase() {
    if (!fs.existsSync(DB_FILE)) {
        fs.writeFileSync(DB_FILE, JSON.stringify({
            totalDonations: 0,
            totalAmount: 0,
            supporters: [],
            transactions: []
        }, null, 2));
    }
}

function getDatabase() {
    try {
        return JSON.parse(fs.readFileSync(DB_FILE, 'utf8'));
    } catch (error) {
        console.error('Database read error:', error);
        return { totalDonations: 0, totalAmount: 0, supporters: [], transactions: [] };
    }
}

function saveDatabase(data) {
    try {
        fs.writeFileSync(DB_FILE, JSON.stringify(data, null, 2));
    } catch (error) {
        console.error('Database save error:', error);
    }
}

function addDonation(userId, username, firstName, amount) {
    const db = getDatabase();
    const now = new Date();
    
    // Add transaction
    db.transactions.push({
        userId,
        username,
        firstName,
        amount,
        timestamp: now.toISOString(),
        date: now.toLocaleDateString('vi-VN')
    });
    
    // Update totals
    db.totalDonations += 1;
    db.totalAmount += amount;
    
    // Add/update supporter
    const existingSupporter = db.supporters.find(s => s.userId === userId);
    if (existingSupporter) {
        existingSupporter.totalAmount += amount;
        existingSupporter.donationCount += 1;
        existingSupporter.lastDonation = now.toISOString();
    } else {
        db.supporters.push({
            userId,
            username,
            firstName,
            totalAmount: amount,
            donationCount: 1,
            firstDonation: now.toISOString(),
            lastDonation: now.toISOString()
        });
    }
    
    saveDatabase(db);
    return db;
}

// Bot commands
bot.onText(/\/start/, (msg) => {
    const chatId = msg.chat.id;
    const firstName = msg.from.first_name || 'B·∫°n';
    
    const welcomeMessage = `
üåü *Ch√†o m·ª´ng ${firstName}!* üåü

C·∫£m ∆°n b·∫°n ƒë√£ gh√© thƒÉm bot donate c·ªßa *Khanh Trann*! 

üíñ *N·∫øu b·∫°n th√≠ch n·ªôi dung c·ªßa t√¥i, h√£y ·ªßng h·ªô t√¥i nh√©!*

üéØ *C√°c m·ª©c ·ªßng h·ªô:*
‚òï *20 Stars* - M·ªôt ly c√† ph√™ nh·ªè
üçú *50 Stars* - B·ªØa tr∆∞a ngon l√†nh  
üöÄ *100 Stars* - ƒê·ªông vi√™n tinh th·∫ßn
üëë *250 Stars* - Si√™u supporter VIP

‚ú® Nh·∫•n n√∫t *"üíñ ·ª¶ng h·ªô Khanh"* ƒë·ªÉ b·∫Øt ƒë·∫ßu!

üôè M·ªçi s·ª± ·ªßng h·ªô ƒë·ªÅu c√≥ √Ω nghƒ©a r·∫•t l·ªõn v·ªõi t√¥i!
    `;
    
    const keyboard = {
        inline_keyboard: [
            [{ text: 'üíñ ·ª¶ng h·ªô Khanh', web_app: { url: `${process.env.WEBAPP_URL || 'https://your-domain.vercel.app'}/donate` } }],
            [{ text: 'üìä Th·ªëng k√™ donate', callback_data: 'stats' }],
            [{ text: 'üëë Top supporters', callback_data: 'top_supporters' }]
        ]
    };
    
    bot.sendMessage(chatId, welcomeMessage, {
        parse_mode: 'Markdown',
        reply_markup: keyboard
    });
});

bot.onText(/\/stats/, (msg) => {
    if (msg.from.id !== 1896302427) { // Only Khanh can see detailed stats
        bot.sendMessage(msg.chat.id, '‚ùå B·∫°n kh√¥ng c√≥ quy·ªÅn xem th·ªëng k√™ chi ti·∫øt.');
        return;
    }
    
    const db = getDatabase();
    const statsMessage = `
üìä *TH·ªêNG K√ä DONATE* üìä

üí∞ *T·ªïng s·ªë donate:* ${db.totalDonations}
‚≠ê *T·ªïng Stars nh·∫≠n:* ${db.totalAmount}
üë• *S·ªë supporters:* ${db.supporters.length}

üèÜ *Top 5 Supporters:*
${db.supporters
    .sort((a, b) => b.totalAmount - a.totalAmount)
    .slice(0, 5)
    .map((s, i) => `${i + 1}. ${s.firstName} - ${s.totalAmount} ‚≠ê`)
    .join('\n')}

üìÖ *Donate g·∫ßn ƒë√¢y:*
${db.transactions
    .slice(-5)
    .reverse()
    .map(t => `‚Ä¢ ${t.firstName}: ${t.amount} ‚≠ê (${t.date})`)
    .join('\n')}
    `;
    
    bot.sendMessage(msg.chat.id, statsMessage, { parse_mode: 'Markdown' });
});

// Callback queries
bot.on('callback_query', (query) => {
    const chatId = query.message.chat.id;
    const data = query.data;
    
    if (data === 'stats') {
        const db = getDatabase();
        const publicStats = `
üìä *TH·ªêNG K√ä DONATE* üìä

üí∞ *T·ªïng donate:* ${db.totalDonations}
‚≠ê *T·ªïng Stars:* ${db.totalAmount}
üë• *Supporters:* ${db.supporters.length}

üíñ C·∫£m ∆°n t·∫•t c·∫£ m·ªçi ng∆∞·ªùi ƒë√£ ·ªßng h·ªô!
        `;
        
        bot.editMessageText(publicStats, {
            chat_id: chatId,
            message_id: query.message.message_id,
            parse_mode: 'Markdown',
            reply_markup: {
                inline_keyboard: [
                    [{ text: 'üíñ ·ª¶ng h·ªô ngay', web_app: { url: `${process.env.WEBAPP_URL || 'https://your-domain.vercel.app'}/donate` } }],
                    [{ text: 'üîô Quay l·∫°i', callback_data: 'back_to_main' }]
                ]
            }
        });
    } else if (data === 'top_supporters') {
        const db = getDatabase();
        const topSupporters = `
üëë *TOP SUPPORTERS* üëë

${db.supporters
    .sort((a, b) => b.totalAmount - a.totalAmount)
    .slice(0, 10)
    .map((s, i) => {
        const medals = ['ü•á', 'ü•à', 'ü•â'];
        const medal = medals[i] || 'üèÖ';
        return `${medal} ${s.firstName}: ${s.totalAmount} ‚≠ê`;
    })
    .join('\n')}

üíñ C·∫£m ∆°n c√°c b·∫°n ƒë√£ ·ªßng h·ªô!
        `;
        
        bot.editMessageText(topSupporters, {
            chat_id: chatId,
            message_id: query.message.message_id,
            parse_mode: 'Markdown',
            reply_markup: {
                inline_keyboard: [
                    [{ text: 'üíñ T√¥i c≈©ng mu·ªën ·ªßng h·ªô!', web_app: { url: `${process.env.WEBAPP_URL || 'https://your-domain.vercel.app'}/donate` } }],
                    [{ text: 'üîô Quay l·∫°i', callback_data: 'back_to_main' }]
                ]
            }
        });
    } else if (data === 'back_to_main') {
        const firstName = query.from.first_name || 'B·∫°n';
        const welcomeMessage = `
üåü *Ch√†o ${firstName}!* üåü

üíñ *·ª¶ng h·ªô Khanh Trann v·ªõi Telegram Stars!*

üéØ *C√°c m·ª©c ·ªßng h·ªô:*
‚òï *20 Stars* - M·ªôt ly c√† ph√™ nh·ªè
üçú *50 Stars* - B·ªØa tr∆∞a ngon l√†nh  
üöÄ *100 Stars* - ƒê·ªông vi√™n tinh th·∫ßn
üëë *250 Stars* - Si√™u supporter VIP

‚ú® Nh·∫•n n√∫t ƒë·ªÉ b·∫Øt ƒë·∫ßu ·ªßng h·ªô!
        `;
        
        bot.editMessageText(welcomeMessage, {
            chat_id: chatId,
            message_id: query.message.message_id,
            parse_mode: 'Markdown',
            reply_markup: {
                inline_keyboard: [
                    [{ text: 'üíñ ·ª¶ng h·ªô Khanh', web_app: { url: `${process.env.WEBAPP_URL || 'https://your-domain.vercel.app'}/donate` } }],
                    [{ text: 'üìä Th·ªëng k√™ donate', callback_data: 'stats' }],
                    [{ text: 'üëë Top supporters', callback_data: 'top_supporters' }]
                ]
            }
        });
    }
    
    bot.answerCallbackQuery(query.id);
});

// Webhook endpoint
app.post('/webhook', async (req, res) => {
    try {
        const update = req.body;
        console.log('Webhook received:', JSON.stringify(update, null, 2));
        
        // Handle pre-checkout query
        if (update.pre_checkout_query) {
            const preCheckoutQuery = update.pre_checkout_query;
            console.log('Pre-checkout query:', preCheckoutQuery);
            
            // Always approve the payment
            await bot.answerPreCheckoutQuery(preCheckoutQuery.id, true);
            console.log('Pre-checkout approved');
        }
        
        // Handle successful payment
        if (update.message && update.message.successful_payment) {
            const payment = update.message.successful_payment;
            const user = update.message.from;
            const chatId = update.message.chat.id;
            
            console.log('Successful payment:', payment);
            console.log('User:', user);
            
            const amount = payment.total_amount;
            const donateConfig = DONATE_AMOUNTS[amount];
            
            if (donateConfig) {
                // Add to database
                addDonation(user.id, user.username, user.first_name, amount);
                
                // Send thank you message
                const thankYouMessage = `
‚ú® *DONATE TH√ÄNH C√îNG!* ‚ú®

${donateConfig.message}

üéØ *Chi ti·∫øt:*
üë§ Supporter: ${user.first_name}
üí∞ S·ªë ti·ªÅn: ${amount} ‚≠ê Stars
üéÅ Lo·∫°i: ${donateConfig.title}

üåü *B·∫°n ƒë√£ tr·ªü th√†nh supporter c·ªßa Khanh Trann!*

üôè S·ª± ·ªßng h·ªô c·ªßa b·∫°n gi√∫p t√¥i ti·∫øp t·ª•c t·∫°o ra nh·ªØng n·ªôi dung t·ªët h∆°n!

üíñ C·∫£m ∆°n b·∫°n r·∫•t r·∫•t nhi·ªÅu!
                `;
                
                const keyboard = {
                    inline_keyboard: [
                        [{ text: 'üíñ ·ª¶ng h·ªô th√™m', web_app: { url: `${process.env.WEBAPP_URL || 'https://your-domain.vercel.app'}/donate` } }],
                        [{ text: 'üìä Xem th·ªëng k√™', callback_data: 'stats' }],
                        [{ text: 'üîÑ Chia s·∫ª bot', switch_inline_query: '·ª¶ng h·ªô Khanh Trann v·ªõi Telegram Stars!' }]
                    ]
                };
                
                await bot.sendMessage(chatId, thankYouMessage, {
                    parse_mode: 'Markdown',
                    reply_markup: keyboard
                });
                
                // Notify Khanh about new donation
                if (user.id !== 1896302427) {
                    const notifyMessage = `
üéâ *NEW DONATION!* üéâ

üë§ *Supporter:* ${user.first_name} (@${user.username || 'no_username'})
üí∞ *Amount:* ${amount} ‚≠ê Stars
üéÅ *Type:* ${donateConfig.title}
üìÖ *Time:* ${new Date().toLocaleString('vi-VN')}

üíñ Ch√∫c m·ª´ng!
                    `;
                    
                    await bot.sendMessage(1896302427, notifyMessage, { parse_mode: 'Markdown' });
                }
                
                console.log(`Donation processed: ${user.first_name} donated ${amount} stars`);
            }
        }
        
        // Handle regular messages
        if (update.message && !update.message.successful_payment) {
            await bot.processUpdate(update);
        }
        
        res.sendStatus(200);
    } catch (error) {
        console.error('Webhook error:', error);
        res.sendStatus(500);
    }
});

// Serve WebApp
app.get('/donate', (req, res) => {
    const webAppHTML = `
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>·ª¶ng h·ªô Khanh Trann</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .donate-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .donate-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .donate-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }
        
        .donate-card.popular {
            background: linear-gradient(135deg, #ffd700, #ffeb3b);
            border: 2px solid #ff6b6b;
        }
        
        .popular-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff6b6b;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
        }
        
        .emoji {
            font-size: 2.5rem;
            margin-bottom: 10px;
            display: block;
        }
        
        .amount {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }
        
        .description {
            font-size: 0.9rem;
            color: #666;
            font-style: italic;
        }
        
        .donate-card.popular .amount {
            color: #333;
        }
        
        .footer {
            text-align: center;
            color: white;
            opacity: 0.8;
        }
        
        .stats {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            color: white;
            text-align: center;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .donate-card:active {
            animation: pulse 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üíñ ·ª¶ng h·ªô Khanh Trann</h1>
            <p>C·∫£m ∆°n s·ª± support c·ªßa b·∫°n!</p>
        </div>
        
        <div class="stats" id="stats">
            <div>üìä ƒêang t·∫£i th·ªëng k√™...</div>
        </div>
        
        <div class="donate-grid">
            <div class="donate-card" onclick="donate(20)">
                <span class="emoji">‚òï</span>
                <div class="amount">20 ‚≠ê</div>
                <div class="description">Ly c√† ph√™ nh·ªè</div>
            </div>
            
            <div class="donate-card popular" onclick="donate(50)">
                <div class="popular-badge">PH·ªî BI·∫æN</div>
                <span class="emoji">üçú</span>
                <div class="amount">50 ‚≠ê</div>
                <div class="description">B·ªØa tr∆∞a ngon</div>
            </div>
            
            <div class="donate-card" onclick="donate(100)">
                <span class="emoji">üöÄ</span>
                <div class="amount">100 ‚≠ê</div>
                <div class="description">ƒê·ªông vi√™n</div>
            </div>
            
            <div class="donate-card" onclick="donate(250)">
                <span class="emoji">üëë</span>
                <div class="amount">250 ‚≠ê</div>
                <div class="description">VIP Supporter</div>
            </div>
        </div>
        
        <div class="footer">
            <p>üí´ M·ªçi s·ª± ·ªßng h·ªô ƒë·ªÅu c√≥ √Ω nghƒ©a!</p>
            <p>üôè C·∫£m ∆°n b·∫°n r·∫•t nhi·ªÅu!</p>
        </div>
    </div>
    
    <script>
        // Initialize Telegram WebApp
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        
        // Load stats
        loadStats();
        
        function loadStats() {
            fetch('/api/stats')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('stats').innerHTML = \`
                        <div>üí∞ T·ªïng donate: \${data.totalDonations}</div>
                        <div>‚≠ê T·ªïng Stars: \${data.totalAmount}</div>
                        <div>üë• Supporters: \${data.supporters}</div>
                    \`;
                })
                .catch(() => {
                    document.getElementById('stats').innerHTML = 'üìä Th·ªëng k√™ s·∫Ω hi·ªÉn th·ªã sau donate ƒë·∫ßu ti√™n';
                });
        }
        
        function donate(amount) {
            const messages = {
                20: 'M·ªôt ly c√† ph√™ nh·ªè ‚òï',
                50: 'B·ªØa tr∆∞a ngon l√†nh üçú',
                100: 'ƒê·ªông vi√™n tinh th·∫ßn üöÄ',
                250: 'Si√™u supporter VIP üëë'
            };
            
            const invoiceParams = {
                title: \`·ª¶ng h·ªô Khanh Trann - \${amount} Stars\`,
                description: messages[amount],
                payload: \`donate_\${amount}_\${Date.now()}\`,
                provider_token: '',
                currency: 'XTR',
                prices: [{ label: 'Donate', amount: amount }]
            };
            
            tg.showInvoice(invoiceParams);
        }
        
        // Handle payment result
        tg.onEvent('invoiceClosed', function(eventData) {
            if (eventData.status === 'paid') {
                tg.showAlert('üíñ C·∫£m ∆°n b·∫°n ƒë√£ ·ªßng h·ªô! Bot s·∫Ω g·ª≠i tin nh·∫Øn c·∫£m ∆°n ngay!');
                setTimeout(() => {
                    loadStats(); // Reload stats
                }, 2000);
            } else if (eventData.status === 'cancelled') {
                tg.showAlert('ƒê√£ h·ªßy thanh to√°n. B·∫°n c√≥ th·ªÉ th·ª≠ l·∫°i b·∫•t c·ª© l√∫c n√†o! üòä');
            }
        });
    </script>
</body>
</html>
    `;
    
    res.send(webAppHTML);
});

// API endpoint for stats
app.get('/api/stats', (req, res) => {
    const db = getDatabase();
    res.json({
        totalDonations: db.totalDonations,
        totalAmount: db.totalAmount,
        supporters: db.supporters.length
    });
});

// Health check
app.get('/', (req, res) => {
    res.send(`
        <h1>ü§ñ Khanh Trann Donate Bot</h1>
        <p>‚úÖ Bot is running!</p>
        <p>üåê WebApp: <a href="/donate">/donate</a></p>
        <p>üìä Stats API: <a href="/api/stats">/api/stats</a></p>
        <p>üíñ Ready to receive donations!</p>
    `);
});

// Initialize database and start server
initDatabase();

app.listen(port, () => {
    console.log(`üöÄ Khanh Trann Donate Bot running on port ${port}`);
    console.log(`üíñ Ready to receive donations!`);
});

// Export for serverless deployment
module.exports = app;